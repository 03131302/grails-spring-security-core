<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>8 Authentication 2.0.0</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction to the Spring Security Plugin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/newInV2.html"><strong>2</strong><span>What's New in Version 2.0</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/domainClasses.html"><strong>3</strong><span>Domain Classes</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/requestMappings.html"><strong>4</strong><span>Configuring Request Mappings to Secure URLs</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/helperClasses.html"><strong>5</strong><span>Helper Classes</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/events.html"><strong>6</strong><span>Events</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/domainClassProperties.html"><strong>7</strong><span>User, Authority (Role), and Requestmap Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/authentication.html"><strong>8</strong><span>Authentication</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/authenticationProviders.html"><strong>9</strong><span>Authentication Providers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/userDetailsService.html"><strong>10</strong><span>Custom UserDetailsService</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/passwords.html"><strong>11</strong><span>Password and Account Protection</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/urlProperties.html"><strong>12</strong><span>URL Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/hierarchicalRoles.html"><strong>13</strong><span>Hierarchical Roles</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/switchUser.html"><strong>14</strong><span>Switch User</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/filters.html"><strong>15</strong><span>Filters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/channelSecurity.html"><strong>16</strong><span>Channel Security</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/ip.html"><strong>17</strong><span>IP Address Restrictions</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/sessionFixation.html"><strong>18</strong><span>Session Fixation Prevention</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/logoutHandlers.html"><strong>19</strong><span>Logout Handlers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/voters.html"><strong>20</strong><span>Voters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/miscProperties.html"><strong>21</strong><span>Miscellaneous Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/tutorials.html"><strong>22</strong><span>Tutorials</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/controllerMetaClassMethods.html"><strong>23</strong><span>Controller MetaClass Methods</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/i18n.html"><strong>24</strong><span>Internationalization</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>Spring Security Core plugin</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/domainClassProperties.html">&lt;&lt; <strong>7</strong><span>User, Authority (Role), and Requestmap Properties</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/authenticationProviders.html"><strong>9</strong><span>Authentication Providers</span> >></a></div>
                


                <div class="project">
                    <h1>8 Authentication - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Burt Beckwith, Beverley Talbott</p>

                    <p><strong>Version:</strong> 2.0.0</p>

                    
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#basicAndDigestAuth"><strong>8.1</strong><span>Basic and Digest Authentication</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#x509"><strong>8.2</strong><span>Certificate (X509) Login Authentication</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#rememberMeCookie"><strong>8.3</strong><span>Remember-Me Cookie</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#ajax"><strong>8.4</strong><span>Ajax Authentication</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="authentication">8 Authentication</h1>
The Spring Security plugin supports several approaches to authentication.<p class="paragraph"/>The default approach stores users and roles in your database, and uses an HTML login form which prompts the user for a username and password. The plugin also supports other approaches as described in the sections below, as well as add-on plugins that provide external authentication providers such as <a href="https://grails.org/plugin/spring-security-ldap" target="blank">LDAP</a> and single sign-on using <a href="https://grails.org/plugin/spring-security-cas" target="blank">CAS</a>



<h2 id="basicAndDigestAuth">8.1 Basic and Digest Authentication</h2>
To use <a href="https://en.wikipedia.org/wiki/Basic_access_authentication" target="blank">HTTP Basic Authentication</a> in your application, set the <code>useBasicAuth</code> attribute to <code>true</code>. Also change the <code>basic.realmName</code> default value to one that suits your application, for example:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.useBasicAuth = <span class="java&#45;keyword">true</span>
grails.plugin.springsecurity.basic.realmName = <span class="java&#45;quote">"Ralph's Bait and Tackle"</span></pre></div><p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td>useBasicAuth</td><td><code>false</code></td><td>Whether to use basic authentication.</td></tr><tr class="table-even"><td>basic.realmName</td><td>'Grails Realm'</td><td>Realm name displayed in the browser authentication popup.</td></tr><tr class="table-odd"><td>basic. credentialsCharset</td><td>'UTF-8'</td><td>The character set used to decode Base64-encoded data</td></tr></table><p class="paragraph"/>With this authentication in place, users are prompted with the standard browser login dialog instead of being redirected to a login page.<p class="paragraph"/>If you don't want all of your URLs guarded by Basic Auth, you can partition the URL patterns and apply Basic Auth to some, but regular form login to others. For example, if you have a web service that uses Basic Auth for <code>/webservice/&#42;&#42;</code> URLs, you would configure that using the <code>chainMap</code> config attribute:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.filterChain.chainMap = &#91;
   '/webservice/&#42;&#42;': 'JOINED_FILTERS,&#45;exceptionTranslationFilter',
   '/&#42;&#42;': 'JOINED_FILTERS,&#45;basicAuthenticationFilter,&#45;basicExceptionTranslationFilter'
&#93;</pre></div><p class="paragraph"/>In this example we're using the <code>JOINED_FILTERS</code> keyword instead of explicitly listing the filter names. Specifying <code>JOINED_FILTERS</code> means to use all of the filters that were configured using the various config options. In each case we also specify that we want to exclude one or more filters by prefixing their names with <code>-</code>.<p class="paragraph"/>For the <code>/webservice/&#42;&#42;</code> URLs, we want all filters except for the standard <code>ExceptionTranslationFilter</code> since we want to use just the one configured for Basic Auth. And for the <code>/&#42;&#42;</code> URLs (everything else) we want everything except for the Basic Auth filter and its configured <code>ExceptionTranslationFilter</code>.<p class="paragraph"/><a href="https://en.wikipedia.org/wiki/Digest_access_authentication" target="blank">Digest Authentication</a> is similar to Basic but is more secure because it does not send your password in obfuscated cleartext. Digest resembles Basic in practice - you get the same browser popup dialog when you authenticate. But because the credential transfer is genuinely hashed (instead of just Base64-encoded as with Basic authentication) you do not need SSL to guard your logins.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>useDigestAuth</td><td><code>false</code></td><td>Whether to use Digest authentication.</td></tr><tr class="table-even"><td>digest.realmName</td><td>'Grails Realm'</td><td>Realm name displayed in the browser popup</td></tr><tr class="table-odd"><td>digest.key</td><td>'changeme'</td><td>Key used to build the nonce for authentication; it should be changed but that's not required.</td></tr><tr class="table-even"><td>digest. nonceValiditySeconds</td><td>300</td><td>How long a nonce stays valid.</td></tr><tr class="table-odd"><td>digest. passwordAlreadyEncoded</td><td><code>false</code></td><td>Whether you are managing the password hashing yourself.</td></tr><tr class="table-even"><td>digest. createAuthenticatedToken</td><td><code>false</code></td><td>If <code>true</code>, creates an authenticated <code>UsernamePasswordAuthenticationToken</code> to avoid loading the user from the database twice. However, this process skips the isAccountNonExpired(), isAccountNonLocked(), isCredentialsNonExpired(), isEnabled() checks, so it is not advised.</td></tr><tr class="table-odd"><td>digest. useCleartextPasswords</td><td><code>false</code></td><td>If <code>true</code>, a cleartext password encoder is used (not recommended). If <code>false</code>, passwords hashed by <code>DigestAuthPasswordEncoder</code> are stored in the database.</td></tr></table><p class="paragraph"/>Digest authentication has a problem in that by default you store cleartext passwords in your database. This is because the browser hashes your password along with the username and Realm name, and this is compared to the password hashed using the same algorithm during authentication. The browser does not know about your <code>MessageDigest</code> algorithm or salt source, so to hash them the same way you need to load a cleartext password from the database.<p class="paragraph"/>The plugin does provide an alternative, although it has no configuration options (in particular the digest algorithm cannot be changed). If <code>digest.useCleartextPasswords</code> is <code>false</code> (the default), then the <code>passwordEncoder</code> bean is replaced with an instance of <code>grails.plugin.springsecurity.authentication.encoding. DigestAuthPasswordEncoder</code>. This encoder uses the same approach as the browser, that is, it combines your password along with your username and Realm name essentially as a salt, and hashes with MD5. MD5 is not recommended in general, but given the typical size of the salt it is reasonably safe to use.<p class="paragraph"/>The only required attribute is <code>useDigestAuth</code>, which you must set to <code>true</code>, but you probably also want to change the realm name:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.useDigestAuth = <span class="java&#45;keyword">true</span>
grails.plugin.springsecurity.digest.realmName = <span class="java&#45;quote">"Ralph's Bait and Tackle"</span></pre></div><p class="paragraph"/>Digest authentication cannot be applied to a subset of URLs like Basic authentication can. This is due to the password encoding issues. So you cannot use the <code>chainMap</code> attribute here - all URLs will be guarded.<p class="paragraph"/><blockquote class="note">
Note that since the Digest auth password encoder is different from the typical encoders you must to pass the username as the "salt" value. The generated User class uses <code>springSecurityService</code> which assumes you're not using a salt value. If you
use the generated code in the User class to encode your password, change the dependency injection for springSecurityService with one for the passwordEncoder bean instead:
<div class="code"><pre><span class="java&#45;keyword">transient</span> passwordEncoder</pre></div><p class="paragraph"/>and change the code in encodePassword() from<p class="paragraph"/><div class="code"><pre>password = springSecurityService.encodePassword(password)</pre></div><p class="paragraph"/>to<p class="paragraph"/><div class="code"><pre>password = passwordEncoder.encodePassword(password, username)</pre></div>
</blockquote>



<h2 id="x509">8.2 Certificate (X509) Login Authentication</h2>
Another authentication mechanism supported by Spring Security is certificate-based, or "mutual authentication". It requires HTTPS, and you must configure the server to require a client certificate (ordinarily only the server provides a certificate). Your username is extracted from the client certificate if it is valid, and you are "pre-authenticated". As long as a corresponding username exists in the database, your authentication succeeds and you are not asked for a password. Your <code>Authentication</code> contains the authorities associated with your username.<p class="paragraph"/>The table describes available configuration options.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>useX509</td><td><code>false</code></td><td>Whether to support certificate-based logins</td></tr><tr class="table-even"><td>x509.continueFilterChainOn UnsuccessfulAuthentication</td><td><code>true</code></td><td>Whether to proceed when an authentication attempt fails to allow other authentication mechanisms to process the request.</td></tr><tr class="table-odd"><td>x509.subjectDnRegex</td><td>'CN=(.*?)(?:,&#124;$)'</td><td>Regular expression (regex) for extracting the username from the certificate's subject name.</td></tr><tr class="table-even"><td>x509.checkForPrincipalChanges</td><td><code>false</code></td><td>Whether to re-extract the username from the certificate and check that it's still the current user when a valid <code>Authentication</code> already exists.</td></tr><tr class="table-odd"><td>x509.invalidateSessionOn PrincipalChange</td><td><code>true</code></td><td>Whether to invalidate the session if the principal changed (based on a <code>checkForPrincipalChanges</code> check).</td></tr><tr class="table-even"><td>x509.subjectDnClosure</td><td>none</td><td>If set, the plugin's <code>ClosureX509PrincipalExtractor</code> class is used to extract information from the X.509 certificate using the specified closure</td></tr><tr class="table-odd"><td>x509. throwException WhenTokenRejected</td><td><code>false</code></td><td>If <code>true</code> thrown a <code>BadCredentialsException</code></td></tr></table><p class="paragraph"/>The details of configuring your server for SSL and configuring browser certificates are beyond the scope of this document. If you use Tomcat, see its <a href="https://tomcat.apache.org/tomcat-8.0-doc/ssl-howto.html" target="blank">SSL documentation</a>. To get a test environment working, see the instructions in <a href="https://stackoverflow.com/questions/1180397/tomcat-server-client-self-signed-ssl-certificate" target="blank">this discussion at Stack Overflow</a>.



<h2 id="rememberMeCookie">8.3 Remember-Me Cookie</h2>
Spring Security supports creating a remember-me cookie so that users are not required to log in with a username and password for each session. This is optional and is usually implemented as a checkbox on the login form; the default <code>auth.gsp</code> supplied by the plugin has this feature.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>rememberMe.cookieName</td><td>'grails_remember_me'</td><td>remember-me cookie name; should be unique per application.</td></tr><tr class="table-even"><td>rememberMe. alwaysRemember</td><td><code>false</code></td><td>If <code>true</code>, create a remember-me cookie even if no checkbox is on the form.</td></tr><tr class="table-odd"><td>rememberMe. tokenValiditySeconds</td><td>1209600 (14 days)</td><td>Max age of the cookie in seconds.</td></tr><tr class="table-even"><td>rememberMe.parameter</td><td>'_spring_security_remember_me'</td><td>Login form remember-me checkbox name.</td></tr><tr class="table-odd"><td>rememberMe.key</td><td>'grailsRocks'</td><td>Value used to encode cookies; should be unique per application.</td></tr><tr class="table-even"><td>rememberMe.useSecureCookie</td><td>none</td><td>Whether to use a secure cookie or not; if <code>true</code> a secure cookie is created, if <code>false</code> a non-secure cookie is created, and if not set, a secure cookie is created if the request used HTTPS</td></tr><tr class="table-odd"><td>rememberMe. createSessionOnSuccess</td><td><code>true</code></td><td>Whether to create a session of one doesn't exist to ensure that the <code>Authentication</code> is stored for future requests</td></tr><tr class="table-even"><td>rememberMe.persistent</td><td><code>false</code></td><td>If <code>true</code>, stores persistent login information in the database.</td></tr><tr class="table-odd"><td>rememberMe.persistentToken. domainClassName</td><td>none</td><td>Domain class used to manage persistent logins.</td></tr><tr class="table-even"><td>rememberMe.persistentToken. seriesLength</td><td>16</td><td>Number of characters in the cookie's <code>series</code> attribute.</td></tr><tr class="table-odd"><td>rememberMe.persistentToken. tokenLength</td><td>16</td><td>Number of characters in the cookie's <code>token</code> attribute.</td></tr><tr class="table-even"><td>atr.rememberMeClass</td><td><a href="https://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/authentication/RememberMeAuthenticationToken.html" target="blank">RememberMeAuthenticationToken</a></td><td>remember-me authentication class.</td></tr></table><p class="paragraph"/>You are most likely to change these attributes:
<ul class="star">
<li><code>rememberMe.cookieName</code>. Purely aesthetic as most users will not look at their cookies, but you probably want the display name to be application-specific rather than "grails_remember_me".</li>
<li><code>rememberMe.key</code>. Part of a salt when the cookie is hashed. Changing the default makes it harder to execute brute-force attacks.</li>
<li><code>rememberMe.tokenValiditySeconds</code>. Default is two weeks; set it to what makes sense for your application.</li>
</ul><p class="paragraph"/><h4>Persistent Logins</h4>
The remember-me cookie is very secure, but for an even stronger solution you can use persistent logins that store the username in the database. See the <a href="https://docs.spring.io/spring-security/site/docs/3.2.x/reference/htmlsingle/#remember-me" target="blank">Spring Security docs</a> for a description of the implementation.<p class="paragraph"/>Persistent login is also useful for authentication schemes like OpenID and Facebook, where you do not manage passwords in your database, but most of the other user information is stored locally. Without a password you cannot use the standard cookie format, so persistent logins enable remember-me cookies in these scenarios.<p class="paragraph"/>To use this feature, run the <a href="../ref/Scripts/s2-create-persistent-token.html" class="Scripts">s2-create-persistent-token</a> script. This will create the domain class, and register its name in <code>grails-app/conf/Config.groovy</code>. It will also enable persistent logins by setting <code>rememberMe.persistent</code> to <code>true</code>.



<h2 id="ajax">8.4 Ajax Authentication</h2>
The typical pattern of using web site authentication to access restricted pages involves intercepting access requests for secure pages, redirecting to a login page (possibly off-site, for example when using a Single Sign-on implementation such as <a href="http://grails.org/plugin/spring-security-cas" target="blank">CAS</a>), and redirecting back to the originally-requested page after a successful login. Each page can also have a login link to allow explicit logins at any time.<p class="paragraph"/>Another option is to also have a login link on each page and to use JavaScript to present a login form within the current page in a popup. The JavaScript code submits the authentication request and displays success or error messages as appropriate.<p class="paragraph"/>The plugin supports Ajax logins, but you need to create your own client-side code. There are only a few necessary changes, and of course the sample code here is pretty basic so you should enhance it for your needs.<p class="paragraph"/>The approach here involves editing your template page(s) to show "You're logged in as ..." text if logged in and a login link if not, along with a hidden login form that is shown using JavaScript.<p class="paragraph"/>This example uses <a href="https://jquery.com/" target="blank">jQuery</a> and <a href="http://jquery.iceburg.net/jqModal/" target="blank">jqModal</a>, a jQuery plugin that creates and manages dialogs and popups. Download <code>jqModal.js</code> and copy it to <code>grails-app/assets/javascripts</code>, and download <code>jqModal.css</code> and copy it to <code>grails-app/assets/stylesheets</code>.<p class="paragraph"/>Create <code>grails-app/assets/javascripts/ajaxLogin.js</code> and add this JavaScript code:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">var</span> onLogin;<p class="paragraph"/>$.ajaxSetup(&#123;
   beforeSend: function(jqXHR, event) &#123;
      <span class="java&#45;keyword">if</span> (event.url != $(<span class="java&#45;quote">"&#35;ajaxLoginForm"</span>).attr(<span class="java&#45;quote">"action"</span>)) &#123;
         // save the 'success' function <span class="java&#45;keyword">for</span> later use <span class="java&#45;keyword">if</span>
         // it wasn't triggered by an explicit login click
         onLogin = event.success;
      &#125;
   &#125;,
   statusCode: &#123;
      // Set up a global Ajax error handler to handle 401
      // unauthorized responses. If a 401 status code is
      // returned the user is no longer logged in (e.g. when
      // the session times out), so re&#45;display the login form.
      401: function() &#123;
         showLogin();
      &#125;
   &#125;
&#125;);<p class="paragraph"/>function showLogin() &#123;
   <span class="java&#45;keyword">var</span> ajaxLogin = $(<span class="java&#45;quote">"&#35;ajaxLogin"</span>);
   ajaxLogin.css(<span class="java&#45;quote">"text&#45;align"</span>, <span class="java&#45;quote">"center"</span>);
   ajaxLogin.jqmShow();
&#125;<p class="paragraph"/>function logout(event) &#123;
   event.preventDefault();
   $.ajax(&#123;
      url: $(<span class="java&#45;quote">"&#35;_logout"</span>).attr(<span class="java&#45;quote">"href"</span>),
      method: <span class="java&#45;quote">"POST"</span>,
      success: function(data, textStatus, jqXHR) &#123;
         window.location = <span class="java&#45;quote">"/"</span>;
      &#125;,
      error: function(jqXHR, textStatus, errorThrown) &#123;
         console.log(<span class="java&#45;quote">"Logout error, textStatus: "</span> + textStatus +
                     <span class="java&#45;quote">", errorThrown: "</span> + errorThrown);
      &#125;
   &#125;);
&#125;<p class="paragraph"/>function authAjax() &#123;
   $(<span class="java&#45;quote">"&#35;loginMessage"</span>).html(<span class="java&#45;quote">"Sending request ..."</span>).show();<p class="paragraph"/>   <span class="java&#45;keyword">var</span> form = $(<span class="java&#45;quote">"&#35;ajaxLoginForm"</span>);
   $.ajax(&#123;
      url:       form.attr(<span class="java&#45;quote">"action"</span>),
      method:   <span class="java&#45;quote">"POST"</span>,
      data:      form.serialize(),
      dataType: <span class="java&#45;quote">"JSON"</span>,
      success: function(json, textStatus, jqXHR) &#123;
         <span class="java&#45;keyword">if</span> (json.success) &#123;
            form&#91;0&#93;.reset();
            $(<span class="java&#45;quote">"&#35;loginMessage"</span>).empty();
            $(<span class="java&#45;quote">"&#35;ajaxLogin"</span>).jqmHide();
            $(<span class="java&#45;quote">"&#35;loginLink"</span>).html(
               'Logged in as ' + json.username +
               ' (&#60;a href=<span class="java&#45;quote">"' + $("</span>&#35;_logout<span class="java&#45;quote">").attr("</span>href<span class="java&#45;quote">") +
               '"</span> id=<span class="java&#45;quote">"logout"</span>&#62;Logout&#60;/a&#62;)');
            $(<span class="java&#45;quote">"&#35;logout"</span>).click(logout);
            <span class="java&#45;keyword">if</span> (onLogin) &#123;
               // execute the saved event.success function
               onLogin(json, textStatus, jqXHR);
            &#125;
         &#125;
         <span class="java&#45;keyword">else</span> <span class="java&#45;keyword">if</span> (json.error) &#123;
            $(<span class="java&#45;quote">"&#35;loginMessage"</span>).html('&#60;span class=<span class="java&#45;quote">"errorMessage"</span>&#62;' +
                                    json.error + <span class="java&#45;quote">"&#60;/error&#62;"</span>);
         &#125;
         <span class="java&#45;keyword">else</span> &#123;
            $(<span class="java&#45;quote">"&#35;loginMessage"</span>).html(jqXHR.responseText);
         &#125;
      &#125;,
      error: function(jqXHR, textStatus, errorThrown) &#123;
         <span class="java&#45;keyword">if</span> (jqXHR.status == 401 &#38;&#38; jqXHR.getResponseHeader(<span class="java&#45;quote">"Location"</span>)) &#123;
            // the login request itself wasn't allowed, possibly because the
            // post url is incorrect and access was denied to it
            $(<span class="java&#45;quote">"&#35;loginMessage"</span>).html('&#60;span class=<span class="java&#45;quote">"errorMessage"</span>&#62;' +
               'Sorry, there was a problem with the login request&#60;/error&#62;');
         &#125;
         <span class="java&#45;keyword">else</span> &#123;
            <span class="java&#45;keyword">var</span> responseText = jqXHR.responseText;
            <span class="java&#45;keyword">if</span> (responseText) &#123;
               <span class="java&#45;keyword">var</span> json = $.parseJSON(responseText);
               <span class="java&#45;keyword">if</span> (json.error) &#123;
                  $(<span class="java&#45;quote">"&#35;loginMessage"</span>).html('&#60;span class=<span class="java&#45;quote">"errorMessage"</span>&#62;' +
                                          json.error + <span class="java&#45;quote">"&#60;/error&#62;"</span>);
                  <span class="java&#45;keyword">return</span>;
               &#125;
            &#125;
            <span class="java&#45;keyword">else</span> &#123;
               responseText = <span class="java&#45;quote">"Sorry, an error occurred (status: "</span> +
                              textStatus + <span class="java&#45;quote">", error: "</span> + errorThrown + <span class="java&#45;quote">")"</span>;
            &#125;
            $(<span class="java&#45;quote">"&#35;loginMessage"</span>).html('&#60;span class=<span class="java&#45;quote">"errorMessage"</span>&#62;' +
                                    responseText + <span class="java&#45;quote">"&#60;/error&#62;"</span>);
         &#125;
      &#125;
   &#125;);
&#125;<p class="paragraph"/>$(function() &#123;
   $(<span class="java&#45;quote">"&#35;ajaxLogin"</span>).jqm(&#123; closeOnEsc: <span class="java&#45;keyword">true</span> &#125;);
   $(<span class="java&#45;quote">"&#35;ajaxLogin"</span>).jqmAddClose(<span class="java&#45;quote">"&#35;cancelLogin"</span>);
   $(<span class="java&#45;quote">"&#35;ajaxLoginForm"</span>).submit(function(event) &#123;
      event.preventDefault();
      authAjax();
   &#125;);
   $(<span class="java&#45;quote">"&#35;authAjax"</span>).click(authAjax);
   $(<span class="java&#45;quote">"&#35;logout"</span>).click(logout);
&#125;);</pre></div><p class="paragraph"/>and create <code>grails-app/assets/stylesheets/ajaxLogin.css</code> and add this CSS:<p class="paragraph"/><div class="code"><pre>&#35;ajaxLogin &#123;
   padding:    0px;
   text&#45;align: center;
   display:    none;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> &#123;
   width:              400px;
   padding&#45;bottom:     6px;
   margin:             60px auto;
   text&#45;align:         left;
   border:             1px solid &#35;aab;
   background&#45;color:   &#35;f0f0fa;
   &#45;moz&#45;box&#45;shadow:    2px 2px 2px &#35;eee;
   &#45;webkit&#45;box&#45;shadow: 2px 2px 2px &#35;eee;
   &#45;khtml&#45;box&#45;shadow:  2px 2px 2px &#35;eee;
   box&#45;shadow:         2px 2px 2px &#35;eee;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .fheader &#123;
   padding:          18px 26px 14px 26px;
   background&#45;color: &#35;f7f7ff;
   margin:           0px 0 14px 0;
   color:            &#35;2e3741;
   font&#45;size:        18px;
   font&#45;weight:      bold;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .cssform p &#123;
   clear:         left;
   margin:        0;
   padding:       4px 0 3px 0;
   padding&#45;left:  105px;
   margin&#45;bottom: 20px;
   height:        1%;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .cssform input&#91;type=<span class="java&#45;quote">"text"</span>&#93;,
&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .cssform input&#91;type=<span class="java&#45;quote">"password"</span>&#93; &#123;
   width: 150px;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .cssform label &#123;
   font&#45;weight:   bold;
   <span class="java&#45;object">float</span>:         left;
   text&#45;align:    right;
   margin&#45;left:  &#45;105px;
   width:         150px;
   padding&#45;top:   3px;
   padding&#45;right: 10px;
&#125;<p class="paragraph"/>.ajaxLoginButton &#123;
   background&#45;color: &#35;efefef;
   font&#45;weight: bold;
   padding: 0.5em 1em;
   display: &#45;moz&#45;inline&#45;stack;
   display: inline&#45;block;
   vertical&#45;align: middle;
   white&#45;space: nowrap;
   overflow: visible;
   text&#45;decoration: none;
      &#45;moz&#45;border&#45;radius: 0.3em;
   &#45;webkit&#45;border&#45;radius: 0.3em;
           border&#45;radius: 0.3em;
&#125;<p class="paragraph"/>.ajaxLoginButton:hover, .ajaxLoginButton:focus &#123;
   background&#45;color: &#35;999999;
   color: &#35;ffffff;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .login_message &#123;
   padding: 6px 25px 20px 25px;
   color:   &#35;c33;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .text_ &#123;
   width: 120px;
&#125;<p class="paragraph"/>&#35;ajaxLogin .<span class="java&#45;keyword">inner</span> .chk &#123;
   height: 12px;
&#125;<p class="paragraph"/>.errorMessage &#123;
   color: red;
&#125;</pre></div><p class="paragraph"/>There's no need to register the JavaScript files in <code>grails-app/assets/javascripts/application.js</code> if you have this <code>require_tree</code> directive:<p class="paragraph"/><div class="code"><pre>//= require_tree .</pre></div><p class="paragraph"/>but you can explicitly include them if you want. Register the two CSS files in <code>/grails-app/assets/stylesheets/application.css</code>:<p class="paragraph"/><div class="code"><pre>/&#42;
 &#8230;
 &#42;= require ajaxLogin
 &#42;= require jqModal
 &#8230;
 &#42;/</pre></div><p class="paragraph"/>We'll need some GSP code to define the HTML, so create <code>grails-app/views/includes/_ajaxLogin.gsp</code> and add this:<p class="paragraph"/><div class="code"><pre>&#60;span id=<span class="java&#45;quote">"logoutLink"</span> style=<span class="java&#45;quote">"display: none;"</span>&#62;
&#60;g:link elementId='_logout' controller='logout'&#62;Logout&#60;/g:link&#62;
&#60;/span&#62;<p class="paragraph"/>&#60;span id=<span class="java&#45;quote">"loginLink"</span> style=<span class="java&#45;quote">"position: relative; margin&#45;right: 30px; <span class="java&#45;object">float</span>: right"</span>&#62;
&#60;sec:ifLoggedIn&#62;
   Logged in as &#60;sec:username/&#62; (&#60;g:link elementId='logout' controller='logout'&#62;Logout&#60;/g:link&#62;)
&#60;/sec:ifLoggedIn&#62;
&#60;sec:ifNotLoggedIn&#62;
   &#60;a href=<span class="java&#45;quote">"&#35;"</span> onclick=<span class="java&#45;quote">"showLogin(); <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">false</span>;"</span>&#62;Login&#60;/a&#62;
&#60;/sec:ifNotLoggedIn&#62;
&#60;/span&#62;<p class="paragraph"/>&#60;div id=<span class="java&#45;quote">"ajaxLogin"</span> class=<span class="java&#45;quote">"jqmWindow"</span> style=<span class="java&#45;quote">"z&#45;index: 3000;"</span>&#62;
   &#60;div class=<span class="java&#45;quote">"<span class="java&#45;keyword">inner</span>"</span>&#62;
      &#60;div class=<span class="java&#45;quote">"fheader"</span>&#62;Please Login..&#60;/div&#62;
      &#60;form action=<span class="java&#45;quote">"$&#123;request.contextPath&#125;/j_spring_security_check"</span>
            method=<span class="java&#45;quote">"POST"</span> id=<span class="java&#45;quote">"ajaxLoginForm"</span> name=<span class="java&#45;quote">"ajaxLoginForm"</span>
            class=<span class="java&#45;quote">"cssform"</span> autocomplete=<span class="java&#45;quote">"off"</span>&#62;
         &#60;p&#62;
            &#60;label <span class="java&#45;keyword">for</span>=<span class="java&#45;quote">"username"</span>&#62;Username:&#60;/label&#62;
            &#60;input type=<span class="java&#45;quote">"text"</span> class=<span class="java&#45;quote">"text_"</span>
                   name=<span class="java&#45;quote">"j_username"</span> id=<span class="java&#45;quote">"username"</span> /&#62;
         &#60;/p&#62;
         &#60;p&#62;
            &#60;label <span class="java&#45;keyword">for</span>=<span class="java&#45;quote">"password"</span>&#62;Password&#60;/label&#62;
            &#60;input type=<span class="java&#45;quote">"password"</span> class=<span class="java&#45;quote">"text_"</span>
                   name=<span class="java&#45;quote">"j_password"</span> id=<span class="java&#45;quote">"password"</span> /&#62;
         &#60;/p&#62;
         &#60;p&#62;
            &#60;label <span class="java&#45;keyword">for</span>=<span class="java&#45;quote">"remember_me"</span>&#62;Remember me&#60;/label&#62;
            &#60;input type=<span class="java&#45;quote">"checkbox"</span> class=<span class="java&#45;quote">"chk"</span> id=<span class="java&#45;quote">"remember_me"</span>
                   name=<span class="java&#45;quote">"_spring_security_remember_me"</span>/&#62;
         &#60;/p&#62;
         &#60;p&#62;
            &#60;input type=<span class="java&#45;quote">"submit"</span> id=<span class="java&#45;quote">"authAjax"</span> name=<span class="java&#45;quote">"authAjax"</span>
                   value=<span class="java&#45;quote">"Login"</span> class=<span class="java&#45;quote">"ajaxLoginButton"</span> /&#62;
            &#60;input type=<span class="java&#45;quote">"button"</span> id=<span class="java&#45;quote">"cancelLogin"</span> value=<span class="java&#45;quote">"Cancel"</span>
                   class=<span class="java&#45;quote">"ajaxLoginButton"</span> /&#62;
         &#60;/p&#62;
      &#60;/form&#62;
      &#60;div style=<span class="java&#45;quote">"display: none; text&#45;align: left;"</span> id=<span class="java&#45;quote">"loginMessage"</span>&#62;&#60;/div&#62;
   &#60;/div&#62;
&#60;/div&#62;</pre></div><p class="paragraph"/>And finally, update the <code>grails-app/views/layouts/main.gsp</code> layout to include <code>_ajaxLogin.gsp</code>, adding it after the <code>&#60;body&#62;</code> tag:<p class="paragraph"/><div class="code"><pre>&#60;html lang=<span class="java&#45;quote">"en"</span> class=<span class="java&#45;quote">"no&#45;js"</span>&#62;
   &#60;head&#62;
      &#8230;
      &#60;g:layoutHead/&#62;
   &#60;/head&#62;
   &#60;body&#62;
      &#60;g:render template='/includes/ajaxLogin'/&#62;
      &#8230;
      &#60;g:layoutBody/&#62;
   &#60;/body&#62;
&#60;/html&#62;</pre></div><p class="paragraph"/>The important aspects of this code are:
<ul class="star">
<li>There is a &#60;span&#62; positioned in the top-right that shows the username and a logout link when logged in, and a login link otherwise.</li>
<li>The form posts to the same URL as the regular form, <code>/j_spring_security_check</code>, and is mostly the same except for the addition of a "Cancel" button (you can also dismiss the dialog by clicking outside of it or with the escape key).</li>
<li>Error messages are displayed within the popup &#60;div&#62;.</li>
<li>Because there is no page redirect after successful login, the Javascript replaces the login link to give a visual indication that the user is logged in.</li>
<li>The Logout link also uses Ajax to submit a POST request to the standard logout url and redirect you to the index page after the request finishes.</li>
<ul class="star">
<li>Note that in the JavaScript <code>logout</code> function, you'll need to change the url in the <code>success</code> callback to the correct post-logout value, e.g. <code>window.location = "/appname";</code></li>
</ul></ul><p class="paragraph"/><h4>How Does Ajax login Work?</h4><p class="paragraph"/>Most Ajax libraries include an <code>X-Requested-With</code> header that indicates that the request was made by <code>XMLHttpRequest</code> instead of being triggered by clicking a regular hyperlink or form submit button. The plugin uses this header to detect Ajax login requests, and uses subclasses of some of Spring Security's classes to use different redirect urls for Ajax requests than regular requests. Instead of showing full pages, <code>LoginController</code> has JSON-generating methods <code>ajaxSuccess()</code>, <code>ajaxDenied()</code>, and <code>authfail()</code> that generate JSON that the login Javascript code can use to appropriately display success or error messages.<p class="paragraph"/>To summarize, the typical flow would be
<ul class="star">
<li>click the link to display the login form</li>
<li>enter authentication details and click Login</li>
<li>the form is submitted using an Ajax request</li>
<li>if the authentication succeeds:</li>
<ul class="star">
<li>a redirect to <code>/login/ajaxSuccess</code> occurs (this URL is configurable)</li>
<li>the rendered response is JSON and it contains two values, a boolean value <code>success</code> with the value <code>true</code> and a string value <code>username</code> with the authenticated user's login name</li>
<li>the client determines that the login was successful and updates the page to indicate the the user is logged in; this is necessary since there's no page redirect like there would be for a non-Ajax login</li>
</ul>
<li>if the authentication fails:</li>
<ul class="star">
<li>a redirect to <code>/login/authfail?ajax=true</code> occurs (this URL is configurable)</li>
<li>the rendered response is JSON and it contains one value, a string value <code>error</code> with the displayable error message; this will be different depending on why the login was unsuccessful (bad username or password, account locked, etc.)</li>
<li>the client determines that the login was not successful and displays the error message</li>
</ul>
<li>note that both a successful and an unsuccessful login will trigger the <code>onSuccess</code> Ajax callback; the <code>onError</code> callback will only be triggered if there's an exception or network issue</li>
</ul><p class="paragraph"/>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/domainClassProperties.html">&lt;&lt; <strong>7</strong><span>User, Authority (Role), and Requestmap Properties</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/authenticationProviders.html"><strong>9</strong><span>Authentication Providers</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Scripts</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../ref/Scripts/s2-create-persistent-token.html">s2-create-persistent-token</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Scripts/s2-create-role-hierarchy-entry.html">s2-create-role-hierarchy-entry</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Scripts/s2-quickstart.html">s2-quickstart</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
