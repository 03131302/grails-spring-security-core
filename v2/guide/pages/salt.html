<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>11.2 Salted Passwords 2.0-RC6</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction to the Spring Security Plugin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/newInV2.html"><strong>2</strong><span>What's New in Version 2.0</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/domainClasses.html"><strong>3</strong><span>Domain Classes</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/requestMappings.html"><strong>4</strong><span>Configuring Request Mappings to Secure URLs</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/helperClasses.html"><strong>5</strong><span>Helper Classes</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/events.html"><strong>6</strong><span>Events</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/domainClassProperties.html"><strong>7</strong><span>User, Authority (Role), and Requestmap Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/authentication.html"><strong>8</strong><span>Authentication</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/authenticationProviders.html"><strong>9</strong><span>Authentication Providers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/userDetailsService.html"><strong>10</strong><span>Custom UserDetailsService</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/passwords.html"><strong>11</strong><span>Password and Account Protection</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/urlProperties.html"><strong>12</strong><span>URL Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/hierarchicalRoles.html"><strong>13</strong><span>Hierarchical Roles</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/switchUser.html"><strong>14</strong><span>Switch User</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/filters.html"><strong>15</strong><span>Filters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/channelSecurity.html"><strong>16</strong><span>Channel Security</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/ip.html"><strong>17</strong><span>IP Address Restrictions</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/sessionFixation.html"><strong>18</strong><span>Session Fixation Prevention</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/logoutHandlers.html"><strong>19</strong><span>Logout Handlers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/voters.html"><strong>20</strong><span>Voters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/miscProperties.html"><strong>21</strong><span>Miscellaneous Properties</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/tutorials.html"><strong>22</strong><span>Tutorials</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/controllerMetaClassMethods.html"><strong>23</strong><span>Controller MetaClass Methods</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/i18n.html"><strong>24</strong><span>Internationalization</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>Spring Security Core plugin</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/userDetailsService.html">&lt;&lt; <strong>10</strong><span>Custom UserDetailsService</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/urlProperties.html"><strong>12</strong><span>URL Properties</span> >></a></div>
                


                <div class="project">
                    <h1>11.2 Salted Passwords - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Burt Beckwith, Beverley Talbott</p>

                    <p><strong>Version:</strong> 2.0-RC6</p>

                    
                </div>

                

                

<h2 id="salt">11.2 Salted Passwords</h2>
The Spring Security plugin uses hashed passwords and a digest algorithm that you specify. For enhanced protection against dictionary attacks, you should use a salt in addition to digest hashing.<p class="paragraph"/><blockquote class="note">
Note that if you use bcrypt (the default setting) or pbkdf2, do not configure a salt (e.g. the <code>dao.reflectionSaltSourceProperty</code> property or a custom <code>saltSource</code> bean) because these algorithms use their own internally.
</blockquote><p class="paragraph"/>There are two approaches to using salted passwords in the plugin - defining a field in the <code>UserDetails</code> class to access by reflection, or by directly implementing <a href="https://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/authentication/dao/SaltSource.html" target="blank">SaltSource</a> yourself.<p class="paragraph"/><h4>dao.reflectionSaltSourceProperty</h4>
Set the <code>dao.reflectionSaltSourceProperty</code> configuration property:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.dao.reflectionSaltSourceProperty = 'username'</pre></div><p class="paragraph"/>This property belongs to the <code>UserDetails</code> class. By default it is an instance of <code>grails.plugin.springsecurity.userdetails.GrailsUser</code>, which extends the standard Spring Security <a href="https://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/core/userdetails/User.html" target="blank">User class</a> and not your 'person' domain class. This limits the available fields unless you use a <a href="../guide/single.html#userDetailsService" class="guide">custom <code>UserDetailsService</code></a>.<p class="paragraph"/>As long as the username does not change, this approach works well for the salt. If you choose a property that the user can change, the user cannot log in again after changing it unless you re-hash the password with the new value. So it's best to use a property that doesn't change.<p class="paragraph"/>Another option is to generate a random salt when creating users and store this in the database by adding a new field to the 'person' class. This approach requires a custom <code>UserDetailsService</code> because you need a custom <code>UserDetails</code> implementation that also has a 'salt' property, but this is more flexible and works in cases where users can change their username.<p class="paragraph"/><h4>SystemWideSaltSource and Custom SaltSource</h4><p class="paragraph"/>Spring Security supplies a simple <code>SaltSource</code> implementation, <a href="https://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/authentication/dao/SystemWideSaltSource.html" target="blank">SystemWideSaltSource</a>, which uses the same salt for each user. It's less robust than using a different value for each user but still better than no salt at all.<p class="paragraph"/>An example override of the salt source bean using SystemWideSaltSource would look like this:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.security.authentication.dao.SystemWideSaltSource
beans = &#123;
   saltSource(SystemWideSaltSource) &#123;
      systemWideSalt = 'the_salt_value'
   &#125;
&#125;</pre></div><p class="paragraph"/>To have full control over the process, you can implement the <code>SaltSource</code> interface and replace the plugin's implementation with your own by defining a bean in <code>grails-app/conf/spring/resources.groovy</code> with the name <code>saltSource</code>:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   saltSource(com.foo.bar.MySaltSource) &#123;
      // set properties
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>Hashing Passwords</h4>
Regardless of the implementation, you need to be aware of what value to use for a salt when creating or updating users, for example, in a <code>UserController</code>'s <code>save</code> or <code>update</code> action. When hashing the password, you use the two-parameter version of <code>springSecurityService.encodePassword()</code>:<p class="paragraph"/><div class="code"><pre>class UserController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def save() &#123;
      def userInstance = <span class="java&#45;keyword">new</span> User(params)
      userInstance.password = springSecurityService.encodePassword(
                    params.password, userInstance.username)
      <span class="java&#45;keyword">if</span> (!userInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'create', model: &#91;userInstance: userInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The user was created"</span>
      redirect action: show, id: userInstance.id
   &#125;<p class="paragraph"/>   def update() &#123;
      def userInstance = User.get(params.id)<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (params.password) &#123;
         params.password = springSecurityService.encodePassword(
                    params.password, userInstance.username)
      &#125;
      userInstance.properties = params
      <span class="java&#45;keyword">if</span> (!userInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;userInstance: userInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (springSecurityService.loggedIn &#38;&#38;
               springSecurityService.principal.username == userInstance.username) &#123;
         springSecurityService.reauthenticate userInstance.username
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The user was updated"</span>
      redirect action: show, id: userInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
If you are encoding the password in the User domain class (using <code>beforeInsert</code> and <code>encodePassword</code>) then don't call <code>springSecurityService.encodePassword()</code> in your controller since you'll double-hash the password and users won't be able to log in. It's best to encapsulate the password handling logic in the domain class. In newer versions of the plugin (version 1.2 and higher) code is auto-generated in the user class so you'll need to adjust that password hashing for your salt approach.
</blockquote>



                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/userDetailsService.html">&lt;&lt; <strong>10</strong><span>Custom UserDetailsService</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/urlProperties.html"><strong>12</strong><span>URL Properties</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Scripts</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../../ref/Scripts/s2-create-persistent-token.html">s2-create-persistent-token</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Scripts/s2-quickstart.html">s2-quickstart</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
